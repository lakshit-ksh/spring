CREATE OR REPLACE FUNCTION upsert_scan_daily_analytics_v2(
    p_qr_code_id TEXT,
    p_date DATE,
    p_ip TEXT,
    p_device TEXT DEFAULT NULL,
    p_browser TEXT DEFAULT NULL,
    p_os TEXT DEFAULT NULL,
    p_country TEXT DEFAULT NULL,
    p_city TEXT DEFAULT NULL
)
RETURNS VOID AS
$$
BEGIN
    INSERT INTO scan_daily_analytics (
        "qrCodeId", "date", "totalScans", "uniqueScans",
        "deviceCounts", "browserCounts", "osCounts",
        "countryCounts", "cityCounts"
    )
    VALUES (
        p_qr_code_id,
        p_date,
        1, -- totalScans incremented automatically
        CASE 
            WHEN NOT EXISTS (
                SELECT 1 
                FROM scan 
                WHERE "qrCodeId" = p_qr_code_id 
                  AND ip = p_ip 
                  AND "scannedAt"::date = p_date
            ) THEN 1 ELSE 0 
        END, -- uniqueScans incremented if new IP
        '{}'::jsonb, '{}'::jsonb, '{}'::jsonb,
        '{}'::jsonb, '{}'::jsonb
    )
    ON CONFLICT ("qrCodeId", "date")
    DO UPDATE SET
        "totalScans" = scan_daily_analytics."totalScans" + 1,
        "uniqueScans" = scan_daily_analytics."uniqueScans" +
            CASE 
                WHEN NOT EXISTS (
                    SELECT 1 
                    FROM scan 
                    WHERE "qrCodeId" = p_qr_code_id 
                      AND ip = p_ip 
                      AND "scannedAt"::date = p_date
                ) THEN 1 ELSE 0 
            END,
        "deviceCounts" = CASE 
            WHEN p_device IS NULL THEN scan_daily_analytics."deviceCounts"
            ELSE jsonb_set(
                scan_daily_analytics."deviceCounts",
                ARRAY[p_device],
                to_jsonb(COALESCE((scan_daily_analytics."deviceCounts"->>p_device)::int, 0) + 1),
                true
            )
        END,
        "browserCounts" = CASE 
            WHEN p_browser IS NULL THEN scan_daily_analytics."browserCounts"
            ELSE jsonb_set(
                scan_daily_analytics."browserCounts",
                ARRAY[p_browser],
                to_jsonb(COALESCE((scan_daily_analytics."browserCounts"->>p_browser)::int, 0) + 1),
                true
            )
        END,
        "osCounts" = CASE 
            WHEN p_os IS NULL THEN scan_daily_analytics."osCounts"
            ELSE jsonb_set(
                scan_daily_analytics."osCounts",
                ARRAY[p_os],
                to_jsonb(COALESCE((scan_daily_analytics."osCounts"->>p_os)::int, 0) + 1),
                true
            )
        END,
        "countryCounts" = CASE 
            WHEN p_country IS NULL THEN scan_daily_analytics."countryCounts"
            ELSE jsonb_set(
                scan_daily_analytics."countryCounts",
                ARRAY[p_country],
                to_jsonb(COALESCE((scan_daily_analytics."countryCounts"->>p_country)::int, 0) + 1),
                true
            )
        END,
        "cityCounts" = CASE 
            WHEN p_city IS NULL THEN scan_daily_analytics."cityCounts"
            ELSE jsonb_set(
                scan_daily_analytics."cityCounts",
                ARRAY[p_city],
                to_jsonb(COALESCE((scan_daily_analytics."cityCounts"->>p_city)::int, 0) + 1),
                true
            )
        END;

END;
$$ LANGUAGE plpgsql;
